<html>

  <head>
  <script>
    username = sessionStorage.getItem('username');
    if(!username) 
      window.location = 'login.html';
  </script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-110075852-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-110075852-1');
  </script>

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/font/material-design-icons/Material-Design-Icons.woff" rel="stylesheet">
  <title>Dashboard</title>
  <style>
    header,
main,
footer {
  padding-left: 240px;
}

body {
  backgroud: white;
}

@media only screen and (max-width: 992px) {
  header,
  main,
  footer {
    padding-left: 0;
  }
}

#credits li,
#credits li a {
  color: white;
}

#credits li a {
  font-weight: bold;
}

.footer-copyright .container,
.footer-copyright .container a {
  color: #BCC2E2;
}

.fab-tip {
  position: fixed;
  right: 85px;
  padding: 0px 0.5rem;
  text-align: right;
  background-color: #323232;
  border-radius: 2px;
  color: #FFF;
  width: auto;
}
  </style>
</head>

<body>


  <ul id="slide-out" class="side-nav fixed z-depth-2">
    <li class="center no-padding">
      <div class="indigo white-text" style="height: 180px;">
        <div class="row">
          <i class="large material-icons">account_circle</i>

          <p style="margin-top: 0%;" id="username">
            User
          </p>
        </div>
      </div>
    </li>

    <li id="dash_dashboard"><a class="waves-effect" href=""><b>Dashboard</b></a></li>

    <ul class="collapsible" data-collapsible="accordion">
      <li id="dash_users">
        <div id="dash_users_header" class="collapsible-header waves-effect"><b>User</b></div>
        <div id="dash_users_body" class="collapsible-body">
          <ul>
            <li id="users_seller">
              <a class="waves-effect navbuttons" id="dash1" style="text-decoration: none;">Profile</a>
            </li>

            <li id="users_customer">
              <a class="waves-effect navbuttons" id="dash2" style="text-decoration: none;">Create Investment</a>
            </li>
            <li id="users_customer">
              <a class="waves-effect navbuttons" id="dash3" style="text-decoration: none;">Current Investment</a>
            </li>
            <li id="users_customer">
              <a class="waves-effect navbuttons" id="dash4" style="text-decoration: none;">Referrals</a>
            </li>
          </ul>
        </div>
      </li>

      <li id="dash_products">
        <div id="btn_logout" class="collapsible-header waves-effect"><b>Logout</b></div>
      </li>

    </ul>
  </ul> 

  <header>
    <ul class="dropdown-content" id="user_dropdown">
      <li><a class="indigo-text  " href="">Profile</a></li>
      <li id="btn_logout"><a href="index.html" class="indigo-text  " id="btn_logout">Logout</a></li>
    </ul>

    <nav class="indigo" role="navigation">
      <div class="nav-wrapper">
        <a data-activates="slide-out" class="button-collapse show-on-" href="#!"><img style="margin-top: 17px; margin-left: 5px;" src="static/logo.png" height="40px" /></a>

        <ul class="right hide-on-med-and-down">
          <li>
            <a class='right dropdown-button' href='' data-activates='user_dropdown'><i class='material-icons'>account_circle</i></a>
          </li>
        </ul>

        <a href="#" data-activates="slide-out" class="button-collapse"><i class="mdi-navigation-menu"></i></a>
      </div>
    </nav>

    <nav>
      <div class="nav-wrapper indigo lighten-1">
        <a style="margin-left: 20px;" class="breadcrumb" href="#">User</a>
        <a class="breadcrumb" href="" id="username"></a>

        <div style="margin-right: 20px;" id="timestamp" class="right"></div>
      </div>
    </nav>
  </header>

  <main>
    <div class="row">
      <div class="col s12">
        <div style="padding: 10px; min-height:700px" class="card">
          <div class="row">
            <div class="left card-title">
              <h4 class="indigo-text">Account</h4>
            </div>
          </div>

          <ul id="tabs-swipe-demo" class="tabs" style="overflow: hidden;">
            <li class="tab col s3">
              <a href="#test-swipe-1" class="active indigo-text  ">Profile</a></li>
            <li class="tab col s3"><a class="indigo-text  "" href="#test-swipe-2">Create Investment</a></li>
            <li class="tab col s3"><a href="#test-swipe-3" class="indigo-text  ">Current Investment</a></li>
            <li class="tab col s3"><a href="#test-swipe-4" class="indigo-text  ">Referrals</a></li>
          </ul>

          <div id="test-swipe-1" class="col s12">
            <div class="container" id="user_pane">
              <h3>Details</h3>
              <div class="row">
                <table class="center highlight responsive-table">
                <thead><tr>
                  <td>Username</td><td>E-mail</td><td>Full Name</td><td>Phone</td><td>Deposit</td><td>Rank</td>
                </tr></thead>
                <tbody><tr>
                  <td id="table_username"></td><td id="table_email"></td><td id="table_fullname"></td><td id="table_phone"><td id="table_deposit"></td><td id="table_rank"></td>
                </tr><tbody>
              </table>
             </div>
             <span id="refcode"></span>
             <br/><br/>
             <a id="btn_rank_req" class="btn waves-effect indigo darken-2"></a>
             <div class="section">
               <h4>Requests</h4>
               <span id="req_details"></span>
             </div>
          </div>
          </div>

          <div id="test-swipe-2" class="col s12">
            <div class="container" id="investment_pane">
              <h3>Create Investment</h3>
              <div class="">
                <div class="row">
                  <div class="col s5">
                    <div class="input-field inline">
                      <input id="investment_amount" type="number" class="validate">
                      <label for="investment_amount">Amount</label>
                      <a id="btn_create_investment" class="left-align indigo waves-effect waves-light btn">Create Investment</a></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          
          <div id="test-swipe-3" class="col s12">
            <div class="container" id="current_pane">
              <h3>Current Investments</h3>
              <div class="center">
                <table>
                  <thead><tr>
                    <td>Investment</td><td>Date</td><td>Status</td>
                  </tr></thead>
                  <tbody id="tbody_investment">
                  <tr>
                    <td id="table_investment"></td><td id="table_date"></td><td id="table_status"></td><td id="table_price"></td>
                  </tr>
                  <tbody>
                </table>
              </div>
            </div>
          </div>

          <div id="test-swipe-4" class="col s12">
            <div class="container" id="user_pane">
              <h3>Referral Accounts</h3>
              <div class="row">
                <table class="center highlight responsive-table">
                <thead><tr>
                  <td>Username</td><td>Rank</td>
                </tr></thead>
                <tbody id="ref_body"><tr>
                  <td id="table_username"></td><td id="table_email"></td><td id="table_fullname"></td><td id="table_phone"></td>
                </tr><tbody>
              </table>
             </div>
             <span id="refcode"></span>
          </div>
          </div>
          
        </div>
      </div>

      <br/><br/>
    

    

    
      

    <div class="fixed-action-btn click-to-toggle" style="bottom: 45px; right: 24px;">
      <a class="btn-floating btn-large pink waves-effect waves-light">
        <i class="large material-icons">add</i>
      </a>

      <ul>
        <li>
          <a class="btn-floating red"><i class="material-icons">note_add</i></a>
          <a href="" class="btn-floating fab-tip">Add a note</a>
        </li>

        <li>
          <a class="btn-floating yellow lighten-1"><i class="material-icons">add_a_photo</i></a>
          <a href="" class="btn-floating fab-tip">Add a photo</a>
        </li>

        <li>
          <a class="btn-floating green"><i class="material-icons">alarm_add</i></a>
          <a href="" class="btn-floating fab-tip">Add an alarm</a>
        </li>

        <li>
          <a class="btn-floating blue"><i class="material-icons">vpn_key</i></a>
          <a href="" class="btn-floating fab-tip">Add a master password</a>
        </li>
      </ul>
    </div>
  </main>

  <footer class="  indigo page-footer">
    <div class="container">
      <div class="row">
        <div class="col l6 s12">
          <h5 class="white-text">Company Bio</h5>
          <p class="grey-text text-lighten-4">We are a leading company that focuses on the Cryptocurrency sector. Our goal is to achieve the highest return from the activity on the Cryptocurrency exchange market.  Investments with Zazzy are affordable and safe.</p>


        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Links</h5>
          <ul>
            <li><a class="white-text" href="about.html">About</a></li>
            <li><a class="white-text" href="contact.html">Contact Us</a></li>
            <li><a class="white-text" href="login.html">Login</a></li>
            <li><a class="white-text" href="signup.html">Signup</a></li>
          </ul>
        </div>
        <div class="col l3 s12">
          <h5 class="white-text">Connect</h5>
          <ul>
            <i class="material-icons white-text">phone</i>&nbsp;&nbsp;&nbsp;
            <i class="material-icons white-text">email</i>&nbsp;&nbsp;&nbsp;
            <i class="material-icons white-text">message</i>&nbsp;&nbsp;&nbsp;
            <i class="material-icons white-text">person</i>
          </ul>
        </div>
      </div>
    </div>
    <div class="footer-copyright">
      <div class="container">
      Made by <a class="brown-text text-lighten-3" href="http://materializecss.com">Materialize</a>
      </div>
    </div>
  </footer>
</body>

  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="js/materialize.js"></script>
  <script src="js/init.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    $('.button-collapse').sideNav();

    $('.collapsible').collapsible();

    $('select').material_select();

    $('#btn_logout').click(()=>{
      sessionStorage.clear();
      console.log('logout');
      window.location = 'index.html';
    });


    $(function(){
      let socket = io();
      username = sessionStorage.getItem('username');
      //console.log(username);
      btcprice = sessionStorage.getItem('btc_price');
      if(!username) return window.location = 'login.html';

      Materialize.toast('Welcome ' + username+"!", 4000);

      $('#btn_create_investment').click(()=>{
        if($('#investment_amount').val() == "")
          return Materialize.toast('You need to enter an amount to create.', 4000);
        data = {
          amount:$('#investment_amount').val(),
          timestamp:Date.now(),
          username:sessionStorage.getItem('username'),
          status:'Pending'
        };
        socket.emit('investment', data);
      });

      socket.emit('dashboard', username);

      socket.on('load', data=>{
        
        $('#username').html(username);
        $('#table_username').html(username);
        $('#table_email').html(data.email);
        $('#table_fullname').html(data.fullname);
        $('#table_phone').html(data.phone);
        $('#refcode').html("Your referral code is : "+data.acc_created);
        $('#table_deposit').html(data.deposit+' ('+parseFloat(data.deposit/btcprice)+' BTC)');
        $('#table_rank').html(((data.rank=="0")?"No rank":data.rank));

        if(data.rank=="0"){
            $('#btn_rank_req').html("Request Rank");
            $('#btn_rank_req').click(()=>{
              //console.log('click');
              if(data.hasOwnProperty("ref_from"))
                socket.emit("rankrequest",{requester:username, to:data.ref_from});
              else
                socket.emit('adminrequest', {requester:username});
              $('#btn_rank_req').html("Request Sent");
              $('#btn_rank_req').addClass('disabled');
            });
            
        }else
          $('#btn_rank_req').hide();


        if(data.hasOwnProperty("referrals")){
          let arr = Object.keys(data.referrals);
          if(arr){
            str = "";
            arr.forEach(a=>{
              //console.log(a);
              str+='<tr><td>'+data.referrals[a]+'</td><td><button class="btn_set_rank btn indigo waves-effect" id="'+data.referrals[a]+'">Set Rank</button></td></tr>';
            });
          }else
            str = "No referrals";
        }else str = "No referrals";
        
        $('#ref_body').html(str);

        $('.btn_set_rank').click(e=>{
          console.log(e.target.id);
            arg = prompt("Enter new rank");
            socket.emit("updaterank", {name:e.target.id, newrank:arg, username:username});
          
          if(parseInt(arg)>0 && parseInt(arg)<data.rank){
            $('#'+e.target.id).attr("disabled", "disabled");
            $('#'+e.target.id).addClass("disabled");
          }
        });
      
      });

      $('#req_details').html("No requests");
      socket.on('requests', r=>{
        //console.log(r.requests);
        if(r.requests != []){
          str = "";
          r.requests.forEach(d=>{
            str += selectbox(r.rank, d)+'<br/>';
          });
          $('#req_details').html(str);
          $('.dropdown-button').dropdown({
            inDuration: 300,
            outDuration: 225,
            constrainWidth: false, // Does not change width of dropdown to that of the activator
            hover: false, // Activate on hover
            gutter: 0, // Spacing from edge
            belowOrigin: false, // Displays dropdown below the button
            alignment: 'left', // Displays dropdown with edge aligned to the left of button
            stopPropagation: false // Stops event propagation
          });
        
        }else
          $('#req_details').html("No requests");

      });


      socket.on('update', data=>{
        //console.log(JSON.stringify(data));
        str = "";
        data.forEach(d=>{
          if(d!=null)
            str+='<tr><td>'+d.amount+' ('+parseFloat(d.amount/btcprice)+' BTC)</td><td>'+(new Date(d.timestamp)).toUTCString()+'</td><td>'+d.status+'</td></tr>';
        })
        $('#tbody_investment').html(str);
  
      });

      socket.on('alert',data=>{
        Materialize.toast(data,4000);
      });
    });

    function selectbox(num, d){
      num = parseInt(num);
      str = "";
      str+='<a class="rval_'+d+' dropdown-button btn indigo" data-activates="dropdown1">'+d+'</a><ul id="dropdown1" class="dropdown-content">';
      for(let i=1 ; i<=num; i++){
        str+='<li><a class="rankval" id="'+d+'_a_'+i+'">'+i+'</a></li>';
      }
      str+='</ul>';
      //console.log(num, str);
      return str;
    }

    
    $('.navbuttons').click(e=>{
      switch(e.target.id){
        case 'dash1': $('ul.tabs').tabs('select_tab', 'test-swipe-1');
          break;
        case 'dash2': $('ul.tabs').tabs('select_tab', 'test-swipe-2');
          break;
        case 'dash3': $('ul.tabs').tabs('select_tab', 'test-swipe-3');
          break;
        case 'dash4': $('ul.tabs').tabs('select_tab', 'test-swipe-4');
          break;
      }
    });
      
  </script>
</html>